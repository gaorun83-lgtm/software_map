<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>æ¢ç´¢ä¹‹æ—… - æ™ºèƒ½æ—…æ¸¸åœ°å›¾</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    /* åŸºæœ¬å¸ƒå±€ï¼ˆå“åº”å¼ï¼Œé€‚é…æ‰‹æœºï¼‰ */
    :root {
      --accent: #2b8aef;
      --bg: #f6f9fc;
      --card: #ffffff;
      --muted: #666;
    }
    html,body{height:100%;margin:0;font-family:Helvetica,Arial,'Microsoft YaHei',sans-serif;background:var(--bg);color:#222}
    .navbar{background:linear-gradient(90deg,#1e90ff,#47b6ff);color:#fff;padding:10px 12px;position:sticky;top:0;z-index:1000}
    .nav-container{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto}
    .nav-logo h1{font-size:18px;margin:0}
    .nav-menu{display:flex;gap:10px}
    .nav-link{color:rgba(255,255,255,0.9);text-decoration:none;padding:6px 10px;border-radius:6px;font-size:14px}
    .nav-link.active{background:rgba(255,255,255,0.12)}
    .main-container{display:flex;gap:12px;max-width:1200px;margin:12px auto;padding:0 12px;box-sizing:border-box}
    aside.sidebar{width:320px;min-width:260px;background:var(--card);border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);height:calc(100vh - 92px);overflow:auto}
    main.map-container{flex:1;position:relative;height:calc(100vh - 92px)}
    #map{height:100%;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    .search-box{display:flex;gap:6px}
    .search-box input{flex:1;padding:8px;border:1px solid #e3e9ef;border-radius:6px}
    .search-box button{padding:8px;border-radius:6px;border:0;background:var(--accent);color:#fff}
    h3,h4{margin:6px 0 10px 0;font-weight:600}
    .filter-group{display:flex;flex-wrap:wrap;gap:6px}
    .filter-item{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
    .results-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .result-card{padding:8px;border-radius:6px;border:1px solid #eef5ff;background:#fbfdff;display:flex;justify-content:space-between;align-items:center}
    .control-row{display:flex;gap:6px;margin-top:8px}
    .control-btn{padding:8px;border-radius:6px;border:0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    .trip-editor{margin-top:12px;border-top:1px dashed #eee;padding-top:12px}
    .trip-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .trip-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;border:1px solid #f0f3f8;background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .btn{padding:8px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff}
    label.row{display:flex;flex-direction:column;font-size:13px;margin-bottom:8px}
    input[type="text"], input[type="datetime-local"], select, textarea{padding:8px;border:1px solid #e9eef5;border-radius:6px}
    textarea{min-height:64px;resize:vertical}
    .map-controls{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:8px;z-index:600}
    .chip{padding:6px 8px;border-radius:20px;border:1px solid #e6eefc;background:#fff;font-size:13px}
     
footer.note{max-width:1200px;margin:8px auto 40px;padding:0 12px;color:#666;font-size:13px}
    
    /* çœŸå®è·¯å¾„ç›¸å…³æ ·å¼ */
    .distance-real {
      background: #fff3cd !important;
      border-color: #ff6b35 !important;
      color: #856404;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .route-info {
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #ff6b35;
    }
    
    @media (max-width:900px){
      aside.sidebar{display:none}
      .main-container{padding:0}
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo"><h1>ğŸŒ æ¢ç´¢ä¹‹æ—…</h1></div>
      <div class="nav-menu">
        <a class="nav-link active">åœ°å›¾</a >
        <a class="nav-link">è¡Œç¨‹</a >
        <a class="nav-link">æ”¶è—</a >
        <a class="nav-link">æˆ‘çš„</a >
      </div>
    </div>
  </nav>

  <div class="main-container">
    <!-- ä¾§è¾¹æ ï¼ˆæ‰‹æœºçª„å±æ—¶éšè—ï¼Œå¯ç”¨æŒ‰é’®å±•å¼€ï¼‰ -->
    <aside class="sidebar" id="sidebar">
      <div class="search-section">
        <h3>æ¢ç´¢ç›®çš„åœ°</h3>
        <div class="search-box">
          <input id="search-input" type="text" placeholder="æœç´¢åœ°ç‚¹æˆ–è¾“å…¥ç»åº¦,çº¬åº¦ (ä¾‹å¦‚: 39.9,116.4)">
          <button id="search-btn">ğŸ”</button>
        </div>
        <div class="control-row" style="margin-top:8px">
          <button id="locate-btn" class="btn">ğŸ“ å®šä½æˆ‘</button>
          <button id="add-manual-btn" class="control-btn">â• æ‰‹åŠ¨æ·»åŠ </button>
          <button id="share-current-btn" class="control-btn" title="åˆ†äº«å½“å‰è¡Œç¨‹åˆ° URL">ğŸ”— åˆ†äº«</button>
<button id="real-route-btn" class="control-btn">ğŸ›£ï¸ çœŸå®è·¯å¾„</button>
        </div>
      </div>

      <div class="filter-section" style="margin-top:12px">
        <h4>åˆ†ç±»ç­›é€‰</h4>
        <div class="filter-group">
          <label class="filter-item"><input type="checkbox" name="category" value="attraction" checked> æ—…æ¸¸æ™¯ç‚¹</label>
          <label class="filter-item"><input type="checkbox" name="category" value="restaurant" checked> ç¾é£Ÿé¤å…</label>
          <label class="filter-item"><input type="checkbox" name="category" value="hotel" checked> ä½å®¿é…’åº—</label>
          <label class="filter-item"><input type="checkbox" name="category" value="shopping" checked> è´­ç‰©ä¸­å¿ƒ</label>
        </div>
      </div>

      <div class="results-section">
        <h4>æœç´¢ç»“æœ</h4>
        <div id="search-results" class="results-list">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
      </div>

      <div class="trip-editor">
        <h4>è¡Œç¨‹ç¼–è¾‘</h4>
        <label class="row">å½“å‰ä½¿ç”¨è€…ï¼ˆç”¨æˆ·åï¼Œç”¨äºæœ¬åœ°ä¿å­˜ï¼‰ï¼š
          <input id="username" type="text" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
        </label>
        <label class="row">è¡Œç¨‹åç§°ï¼š
          <input id="trip-name" type="text" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ä¸‰æ—¥æ¸¸">
        </label>
        <label class="row">å¼€å§‹æ—¥æœŸ/æ—¶é—´ï¼š
          <input id="trip-start" type="datetime-local">
        </label>
        <label class="row">äº¤é€šæ–¹å¼ï¼š
          <select id="transport-mode">
            <option value="walk">æ­¥è¡Œ</option>
            <option value="car">è‡ªé©¾/å‡ºç§Ÿ</option>
            <option value="public">å…¬å…±äº¤é€š</option>
            <option value="bike">éª‘è¡Œ</option>
          </select>
        </label>
        <label class="row">å¤‡æ³¨ï¼š
          <textarea id="trip-notes" placeholder="å¡«å†™ä½å®¿ã€é¢„ç®—ã€è”ç³»äººç­‰"></textarea>
        </label>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="save-trip-btn" class="btn">ğŸ’¾ ä¿å­˜è¡Œç¨‹</button>
          <button id="export-trip-btn" class="control-btn">â¬‡ å¯¼å‡º JSON</button>
          <button id="import-trip-btn" class="control-btn">â¬† å¯¼å…¥ JSON</button>
          <input id="import-file" type="file" accept=".json" style="display:none">
        </div>

        <h4 style="margin-top:12px">å½“å‰è¡Œç¨‹åœ°ç‚¹</h4>
        <div id="trip-places" class="trip-list small"></div>

        <h4 style="margin-top:12px">å·²ä¿å­˜è¡Œç¨‹</h4>
        <div id="saved-trips" class="trip-list"></div>
      </div>
    </aside>

    <!-- åœ°å›¾åŒºåŸŸ -->
    <main class="map-container">
      <div id="map"></div>
      <div class="map-controls" aria-hidden>
        <div class="chip" id="distance-chip">æ€»è·: 0 km</div>
        <button id="toggle-sidebar" class="control-btn" title="æ˜¾ç¤º/éšè—ä¾§æ ">â˜°</button>
      </div>
    </main>
  </div>

  <footer class="note">
æç¤ºï¼šç‚¹å‡»åœ°å›¾æ·»åŠ åœ°ç‚¹ â†’ å¡«å†™æ—¶é—´/äº¤é€š/å¤‡æ³¨ â†’ ä¿å­˜è¡Œç¨‹ã€‚ç‚¹å‡»â€œåˆ†äº«â€ä¼šæŠŠå½“å‰è¡Œç¨‹ç¼–ç åˆ°é¡µé¢ URLï¼Œå¤åˆ¶ URL å‘é€ç»™æœ‹å‹å³å¯æŸ¥çœ‹è¯¥è¡Œç¨‹ï¼ˆä¸å«éšç§æ•°æ®ï¼‰ã€‚
  </footer>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // ---------- å·¥å…·ä¸æ•°æ®ç»“æ„è¯´æ˜ ----------
    // localStorage æ•°æ®ç»“æ„ï¼ˆç¤ºä¾‹ï¼‰
    // trips_store = {
    //   users: {
    //     "å¼ ä¸‰": [ tripObj, tripObj, ... ],
    //     "æå››": [ ... ]
    //   }
    // }
    //
    // tripObj = {
    //   id, name, start, transport, notes, places: [{id, name, lat, lng, time, note}], createdAt
    // }
    //
    // åˆ†äº«ï¼šæŠŠå•ä¸ª tripObj base64(JSON) æ”¾åˆ° URL å‚æ•° `share`
    // ---------- åˆå§‹åŒ– ----------
    const map = L.map('map').setView([39.9042, 116.4074], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

    // state
    let currentTrip = { id: genId(), name: '', start: null, transport: 'walk', notes: '', places: [] };
let markers = []; // leaflet markers for currentTrip
let polyline = null;
let realRoutePolyline = null; // æ–°å¢ï¼šçœŸå®è·¯å¾„å›¾å±‚
let routeControl = null; // æ–°å¢ï¼šè·¯çº¿æ§åˆ¶

    // DOM
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchResults = document.getElementById('search-results');
    const tripPlacesEl = document.getElementById('trip-places');
    const usernameEl = document.getElementById('username');
    const tripNameEl = document.getElementById('trip-name');
    const tripStartEl = document.getElementById('trip-start');
    const transportEl = document.getElementById('transport-mode');
    const tripNotesEl = document.getElementById('trip-notes');
    const saveTripBtn = document.getElementById('save-trip-btn');
    const savedTripsEl = document.getElementById('saved-trips');
    const exportBtn = document.getElementById('export-trip-btn');
    const importBtn = document.getElementById('import-trip-btn');
    const importFile = document.getElementById('import-file');
    const locateBtn = document.getElementById('locate-btn');
    const addManualBtn = document.getElementById('add-manual-btn');
    const shareBtn = document.getElementById('share-current-btn');
const realRouteBtn = document.getElementById('real-route-btn'); // æ–°å¢
    const distanceChip = document.getElementById('distance-chip');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar');
    const sidebar = document.getElementById('sidebar');

    // äº‹ä»¶ç»‘å®š
    map.on('click', onMapClick);
    searchBtn.addEventListener('click', onSearch);
    saveTripBtn.addEventListener('click', onSaveTrip);
    exportBtn.addEventListener('click', onExportTrip);
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', onImportFile);
    locateBtn.addEventListener('click', onLocateMe);
    addManualBtn.addEventListener('click', onAddManual);
    shareBtn.addEventListener('click', onShareCurrent);
realRouteBtn.addEventListener('click', onRealRoute); // æ–°å¢
    toggleSidebarBtn.addEventListener('click', () => { sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none'; });

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ URL share å‚æ•°
    (function initFromUrl() {
      const urlParams = new URLSearchParams(location.search);
      const share = urlParams.get('share');
      if (share) {
        try {
          const json = JSON.parse(atob(decodeURIComponent(share)));
          // æ˜¾ç¤ºåªè¯»è§†å›¾çš„å½“å‰Tripï¼ˆä¸è¦†ç›–æœ¬åœ°æ•°æ®ï¼‰
          currentTrip = json;
          renderCurrentTrip();
          drawTripOnMap();
        } catch (e) {
          console.warn('åˆ†äº«è§£æå¤±è´¥', e);
        }
      } else {
        loadSavedTripsUI();
      }
    })();

    // ---------- åœ°å›¾æ·»åŠ åœ°ç‚¹ ----------
    function onMapClick(e) {
      const lat = e.latlng.lat, lng = e.latlng.lng;
      const name = prompt('ä¸ºæ­¤åœ°ç‚¹å‘½åï¼ˆä¾‹å¦‚ï¼šæ•…å®«ï¼‰æˆ–ç•™ç©ºä½¿ç”¨åæ ‡ï¼š') || `åœ°ç‚¹ ${lat.toFixed(5)},${lng.toFixed(5)}`;
      if (name === null) return;
      const place = { id: genId(), name, lat, lng, time: '', note: '' };
      currentTrip.places.push(place);
      addMarkerForPlace(place);
      renderCurrentTrip();
      drawTripOnMap();
    }

    function addMarkerForPlace(place) {
      const m = L.marker([place.lat, place.lng], { title: place.name }).addTo(map)
        .bindPopup(`<b>${escapeHtml(place.name)}</b><br><button data-id="${place.id}" class="goto-btn">èšç„¦</button> <button data-id="${place.id}" class="del-btn">åˆ é™¤</button>`);
      m.on('popupopen', () => {
        setTimeout(() => {
          attachPopupButtons();
        }, 50);
      });
      markers.push({ id: place.id, marker: m });
    }

    function attachPopupButtons() {
      document.querySelectorAll('.goto-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id'); const p = currentTrip.places.find(x => x.id === id);
          if (p) map.setView([p.lat, p.lng], 15);
        };
      });
      document.querySelectorAll('.del-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id'); removePlaceById(id);
        };
      });
    }

    // ---------- æœç´¢ï¼ˆç®€æ˜“ï¼šå¦‚æœè¾“å…¥ "lat,lng" åˆ™ç›´æ¥è§£æï¼›å¦åˆ™å°è¯• Nominatim ç®€å•è¯·æ±‚ï¼‰ ----------
    async function onSearch() {
      const q = searchInput.value.trim();
      searchResults.innerHTML = '';
      if (!q) return;
      // æ£€æŸ¥æ˜¯å¦ä¸ºç»çº¬åº¦å¯¹
      const latlng = q.split(',').map(s => s.trim()).map(Number);
      if (latlng.length === 2 && !isNaN(latlng[0]) && !isNaN(latlng[1])) {
        const res = [{ display_name: `ä½ç½® ${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)}`, lat: latlng[0], lon: latlng[1] }];
        renderSearchResults(res);
        return;
      }
      // ä½¿ç”¨ OSM Nominatimï¼ˆæ—  API keyï¼Œä½†è¯·æ³¨æ„æµé‡é™åˆ¶ï¼›ä½œä¸ºåŸå‹å¯ç”¨ï¼‰
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=6`);
        const j = await r.json();
        renderSearchResults(j);
      } catch (e) {
        searchResults.innerHTML = `<div class="result-card">æœç´¢å¤±è´¥ï¼ˆè¯·æ£€æŸ¥ç½‘ç»œï¼‰</div>`;
      }
    }

    function renderSearchResults(list) {
      searchResults.innerHTML = '';
      if (!list || !list.length) {
        searchResults.innerHTML = `<div class="result-card">æœªæ‰¾åˆ°ç»“æœ</div>`; return;
      }
      list.forEach((item) => {
        const name = item.display_name || item.name || `${item.lat},${item.lon}`;
        const card = document.createElement('div'); card.className = 'result-card';
        card.innerHTML = `<div style="flex:1"><div style="font-weight:600">${escapeHtml(name)}</div><div class="small">${item.type||''}</div></div>
                          <div style="display:flex;flex-direction:column;gap:6px">
                            <button class="control-btn add-place" data-lat="${item.lat||item.lat}" data-lng="${item.lon||item.lon}" data-name="${escapeAttr(name)}">â• æ·»åŠ </button>
                            <button class="control-btn goto-result" data-lat="${item.lat||item.lat}" data-lng="${item.lon||item.lon}">ğŸ” æŸ¥çœ‹</button>
                          </div>`;
        searchResults.appendChild(card);
      });
      // bind buttons
      document.querySelectorAll('.add-place').forEach(btn => {
        btn.onclick = () => {
          const lat = parseFloat(btn.dataset.lat), lng = parseFloat(btn.dataset.lng), name = btn.dataset.name;
          const place = { id: genId(), name, lat, lng, time: '', note: '' };
          currentTrip.places.push(place);
          addMarkerForPlace(place);
          renderCurrentTrip();
          drawTripOnMap();
        };
      });
      document.querySelectorAll('.goto-result').forEach(btn => {
        btn.onclick = () => {
          const lat = parseFloat(btn.dataset.lat), lng = parseFloat(btn.dataset.lng);
          map.setView([lat, lng], 15);
        };
      });
    }

    // ---------- è¡Œç¨‹æ“ä½œï¼ˆä¿å­˜/åŠ è½½/å¯¼å‡º/å¯¼å…¥ï¼‰ ----------
    function onSaveTrip() {
      const username = (usernameEl.value || 'guest').trim();
if (!username) alert('è¯·å¡«å†™ç”¨æˆ·åç”¨äºä¿å­˜'); 
      currentTrip.name = tripNameEl.value || currentTrip.name || `è¡Œç¨‹ ${new Date().toLocaleString()}`;
      currentTrip.start = tripStartEl.value || currentTrip.start;
      currentTrip.transport = transportEl.value;
      currentTrip.notes = tripNotesEl.value;
      currentTrip.updatedAt = new Date().toISOString();

      const store = loadStore();
      store.users = store.users || {};
      store.users[username] = store.users[username] || [];
      // å¦‚æœå·²å­˜åœ¨ç›¸åŒ idï¼Œæ›¿æ¢ï¼›å¦åˆ™ push
      const idx = store.users[username].findIndex(t => t.id === currentTrip.id);
      if (idx >= 0) store.users[username][idx] = currentTrip;
      else store.users[username].push(currentTrip);
      saveStore(store);
      alert('å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰');
      loadSavedTripsUI();
    }

    function onExportTrip() {
      const blob = new Blob([JSON.stringify(currentTrip, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${(currentTrip.name||'trip').replace(/\s+/g,'_')}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function onImportFile(e) {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          // å°†å¯¼å…¥çš„ trip è®¾ä¸ºå½“å‰å¹¶æ¸²æŸ“
          currentTrip = obj;
          renderCurrentTrip();
          clearMapMarkers();
          currentTrip.places.forEach(p => addMarkerForPlace(p));
          drawTripOnMap();
          alert('å·²å¯¼å…¥å¹¶è½½å…¥ä¸ºå½“å‰è¡Œç¨‹ï¼ˆä»…æœ¬åœ°ï¼‰');
        } catch (err) {
          alert('JSON è§£æå¤±è´¥');
        }
      };
      reader.readAsText(f);
    }

    function loadSavedTripsUI() {
      savedTripsEl.innerHTML = '';
      const store = loadStore();
      if (!store.users) return;
      const username = (usernameEl.value || 'guest').trim();
      const users = Object.keys(store.users);
      // show grouped by user
      users.forEach(u => {
        const header = document.createElement('div'); header.className = 'small'; header.style.fontWeight = '600'; header.textContent = u;
        savedTripsEl.appendChild(header);
        store.users[u].forEach(trip => {
          const item = document.createElement('div'); item.className = 'trip-item';
          item.innerHTML = `<div>
                              <div style="font-weight:600">${escapeHtml(trip.name||'æ— å')}</div>
                              <div class="small">${trip.start||''} Â· ${trip.places?trip.places.length:0} åœ°ç‚¹</div>
                            </div>
                            <div style="display:flex;gap:6px;flex-direction:column">
                              <button class="control-btn load-trip" data-user="${u}" data-id="${trip.id}">åŠ è½½</button>
                              <button class="control-btn del-trip" data-user="${u}" data-id="${trip.id}">åˆ é™¤</button>
                            </div>`;
          savedTripsEl.appendChild(item);
        });
      });
      // bind
      document.querySelectorAll('.load-trip').forEach(btn => {
        btn.onclick = () => {
          const user = btn.dataset.user, id = btn.dataset.id;
          const store = loadStore();
          const trip = (store.users && store.users[user] || []).find(t => t.id === id);
          if (trip) {
            currentTrip = JSON.parse(JSON.stringify(trip)); // clone
            renderCurrentTrip();
            clearMapMarkers();
            currentTrip.places.forEach(p => addMarkerForPlace(p));
            drawTripOnMap();
          }
        };
      });
      document.querySelectorAll('.del-trip').forEach(btn => {
        btn.onclick = () => {
          if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è¡Œç¨‹ï¼ˆä»…æœ¬åœ°ï¼‰ï¼Ÿ')) return;
          const user = btn.dataset.user, id = btn.dataset.id;
          const store = loadStore();
          store.users[user] = (store.users[user] || []).filter(t => t.id !== id);
          saveStore(store);
          loadSavedTripsUI();
        };
      });
    }

    // ---------- æ¸²æŸ“å½“å‰è¡Œç¨‹åœ°ç‚¹é¢æ¿ ----------
    function renderCurrentTrip() {
      tripNameEl.value = currentTrip.name || '';
      tripStartEl.value = currentTrip.start || '';
      transportEl.value = currentTrip.transport || 'walk';
      tripNotesEl.value = currentTrip.notes || '';
      // list places
      tripPlacesEl.innerHTML = '';
      if (!currentTrip.places) currentTrip.places = [];
      currentTrip.places.forEach((p,i) => {
        const row = document.createElement('div'); row.className = 'trip-item';
        row.innerHTML = `<div>
            <div style="font-weight:600">${escapeHtml(p.name)}</div>
            <div class="small">${p.time||''} ${p.note?('Â· '+escapeHtml(p.note)):''}</div>
          </div>
          <div style="display:flex;gap:6px;flex-direction:column">
            <button class="control-btn focus" data-id="${p.id}">ğŸ”</button>
            <button class="control-btn edit" data-id="${p.id}">âœ</button>
          </div>`;
        tripPlacesEl.appendChild(row);
      });
      // bind place buttons
      tripPlacesEl.querySelectorAll('.focus').forEach(b => { b.onclick = ()=>{ const id=b.dataset.id; const p=currentTrip.places.find(x=>x.id===id); if(p) map.setView([p.lat,p.lng],15); }; });
      tripPlacesEl.querySelectorAll('.edit').forEach(b => { b.onclick = ()=>{ editPlacePopup(b.dataset.id); }; });
      // update saved trips UI
      loadSavedTripsUI();
      updateDistanceChip();
    }

    function editPlacePopup(id) {
      const p = currentTrip.places.find(x => x.id === id);
      if (!p) return;
      const newName = prompt('åœ°ç‚¹åç§°ï¼š', p.name);
      if (newName === null) return;
      p.name = newName;
      const newTime = prompt('åˆ°è¾¾æ—¶é—´ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', p.time||'');
      if (newTime !== null) p.time = newTime;
      const newNote = prompt('å¤‡æ³¨ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', p.note||'');
      if (newNote !== null) p.note = newNote;
      renderCurrentTrip();
      // update marker popup if exists
      const mk = markers.find(m => m.id === id);
      if (mk) mk.marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br><button data-id="${p.id}" class="goto-btn">èšç„¦</button> <button data-id="${p.id}" class="del-btn">åˆ é™¤</button>`);
    }

    function removePlaceById(id) {
      currentTrip.places = currentTrip.places.filter(p => p.id !== id);
      // remove marker
      const idx = markers.findIndex(m => m.id === id);
      if (idx >= 0) { map.removeLayer(markers[idx].marker); markers.splice(idx,1); }
      renderCurrentTrip(); drawTripOnMap();
    }

    // ---------- åœ°å›¾ç»˜åˆ¶è·¯çº¿ & ä¼°ç®—è·ç¦» ----------
       function drawTripOnMap() {
      if (polyline) {
        map.removeLayer(polyline);
        polyline = null;
      }
      // æ¸…é™¤çœŸå®è·¯å¾„æ˜¾ç¤º
      if (realRoutePolyline) {
        map.removeLayer(realRoutePolyline);
        realRoutePolyline = null;
      }
      // æ¢å¤è·ç¦»èŠ¯ç‰‡æ ·å¼
      distanceChip.style.background = '';
      distanceChip.style.borderColor = '';
      
      if (!currentTrip.places || currentTrip.places.length < 2) {
        updateDistanceChip();
        return;
      }
      
      const latlngs = currentTrip.places.map(p => [p.lat, p.lng]);
      polyline = L.polyline(latlngs, { 
        color: '#2b8aef', 
        weight: 4, 
        opacity: 0.6,
        dashArray: '5, 10' // è™šçº¿è¡¨ç¤ºè¿™æ˜¯ç›´çº¿è·ç¦»
      }).addTo(map);
      
      map.fitBounds(polyline.getBounds(), { padding: [40, 40] });
      updateDistanceChip();
    }

    function updateDistanceChip() {
      let d = 0;
      const ps = currentTrip.places || [];
      for (let i=1;i<ps.length;i++) d += haversine(ps[i-1].lat,ps[i-1].lng, ps[i].lat,ps[i].lng);
      distanceChip.textContent = `æ€»è·: ${d.toFixed(2)} km`;
    }

    // haversine km
    function haversine(lat1,lon1,lat2,lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ---------- å¸®åŠ©æ–¹æ³•ï¼šæœ¬åœ°å­˜å‚¨ ----------
    function loadStore() {
      try { return JSON.parse(localStorage.getItem('trips_store') || '{}'); } catch(e) { return {}; }
    }
    function saveStore(obj) { localStorage.setItem('trips_store', JSON.stringify(obj)); }

        function clearMapMarkers() {
      markers.forEach(mo => { try { map.removeLayer(mo.marker); } catch(e){} });
      markers = [];
      if (polyline) { map.removeLayer(polyline); polyline = null; }
      if (realRoutePolyline) { map.removeLayer(realRoutePolyline); realRoutePolyline = null; } // æ–°å¢
      // æ¢å¤è·ç¦»èŠ¯ç‰‡
      distanceChip.style.background = '';
      distanceChip.style.borderColor = '';
      updateDistanceChip();
    }

    // ---------- å®šä½ã€æ‰‹åŠ¨æ·»åŠ ã€åˆ†äº« ----------
    function onLocateMe() {
      if (!navigator.geolocation) return alert('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat,lng],14);
        const place = { id: genId(), name: 'æˆ‘çš„ä½ç½®', lat, lng, time:'', note:'' };
        currentTrip.places.push(place);
        addMarkerForPlace(place); renderCurrentTrip(); drawTripOnMap();
      }, err => alert('å®šä½å¤±è´¥ï¼š' + err.message));
    }

    function onAddManual() {
      const name = prompt('åœ°ç‚¹åç§°ï¼š'); if (name===null) return;
      const lat = parseFloat(prompt('çº¬åº¦ (ä¾‹å¦‚ 39.9)ï¼š')); if (isNaN(lat)) return alert('éæ³•çº¬åº¦');
      const lng = parseFloat(prompt('ç»åº¦ (ä¾‹å¦‚ 116.4)ï¼š')); if (isNaN(lng)) return alert('éæ³•ç»åº¦');
      const place = { id: genId(), name, lat, lng, time: '', note: '' };
      currentTrip.places.push(place);
      addMarkerForPlace(place); renderCurrentTrip(); drawTripOnMap();
    }

    function onShareCurrent() {
      const toShare = JSON.parse(JSON.stringify(currentTrip));
      // base64 ç¼–ç ï¼ˆURI encoded åå† btoaï¼‰
      const s = encodeURIComponent(btoa(JSON.stringify(toShare)));
      const url = `${location.origin}${location.pathname}?share=${s}`;
      window.prompt('å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ†äº«ç»™ä»–äººï¼ˆæ‰“å¼€åä¼šè½½å…¥æ­¤è¡Œç¨‹ï¼‰', url);
    }

    // ---------- çœŸå®è·¯å¾„å¯¼èˆªåŠŸèƒ½ ----------
    async function onRealRoute() {
      if (!currentTrip.places || currentTrip.places.length < 2) {
        alert('è‡³å°‘éœ€è¦ä¸¤ä¸ªåœ°ç‚¹æ‰èƒ½è®¡ç®—è·¯å¾„');
        return;
      }

      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        realRouteBtn.innerHTML = 'ğŸ”„ è®¡ç®—ä¸­...';
        realRouteBtn.disabled = true;

        // æ¸…é™¤ä¹‹å‰çš„çœŸå®è·¯å¾„
        if (realRoutePolyline) {
          map.removeLayer(realRoutePolyline);
          realRoutePolyline = null;
        }
        if (routeControl) {
          map.removeControl(routeControl);
          routeControl = null;
        }

        // æ ¹æ®äº¤é€šæ–¹å¼é€‰æ‹©OSRMé…ç½®æ–‡ä»¶
        const profile = getOSRMProfile(currentTrip.transport);
        
        // æ„å»ºåæ ‡å­—ç¬¦ä¸²ï¼šç»åº¦,çº¬åº¦;ç»åº¦,çº¬åº¦...
        const coordinates = currentTrip.places.map(place => 
          `${place.lng},${place.lat}`
        ).join(';');

        // è°ƒç”¨OSRM API
        const url = `https://router.project-osrm.org/route/v1/${profile}/${coordinates}?overview=full&geometries=geojson`;
        
        const response = await fetch(url);
        const data = await response.json();

        if (data.code !== 'Ok') {
          throw new Error('è·¯å¾„è®¡ç®—å¤±è´¥: ' + data.message);
        }

        // æå–è·¯å¾„å‡ ä½•æ•°æ®
        const route = data.routes[0];
        const routeGeometry = route.geometry;
        
        // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çœŸå®è·¯å¾„
        realRoutePolyline = L.geoJSON(routeGeometry, {
          style: {
            color: '#ff6b35',
            weight: 6,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
          }
        }).addTo(map);

        // æ›´æ–°è·ç¦»æ˜¾ç¤ºï¼ˆä½¿ç”¨çœŸå®è·¯å¾„è·ç¦»ï¼‰
        const realDistance = (route.distance / 1000).toFixed(2); // è½¬æ¢ä¸ºå…¬é‡Œ
        distanceChip.textContent = `çœŸå®è·ç¦»: ${realDistance} km`;
        distanceChip.style.background = '#fff3cd';
        distanceChip.style.borderColor = '#ff6b35';

        // æ·»åŠ è·¯å¾„ä¿¡æ¯å¼¹å‡ºçª—å£
        realRoutePolyline.bindPopup(`
          <div style="min-width: 200px">
            <strong>è·¯å¾„ä¿¡æ¯</strong><br>
            è·ç¦»: ${realDistance} km<br>
            é¢„è®¡æ—¶é—´: ${formatDuration(route.duration)}<br>
            äº¤é€šæ–¹å¼: ${getTransportName(currentTrip.transport)}
          </div>
        `);

        // è‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡æ˜¾ç¤ºæ•´ä¸ªè·¯å¾„
        map.fitBounds(realRoutePolyline.getBounds(), { padding: [40, 40] });

        alert(`çœŸå®è·¯å¾„è®¡ç®—å®Œæˆï¼è·ç¦»: ${realDistance} kmï¼Œé¢„è®¡æ—¶é—´: ${formatDuration(route.duration)}`);

      } catch (error) {
        console.error('è·¯å¾„è®¡ç®—é”™è¯¯:', error);
        alert('è·¯å¾„è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
        
        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ç›´çº¿è·¯å¾„
        drawTripOnMap();
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        realRouteBtn.innerHTML = 'ğŸ›£ï¸ çœŸå®è·¯å¾„';
        realRouteBtn.disabled = false;
      }
    }

    function getOSRMProfile(transport) {
      const profiles = {
        'car': 'driving',
        'walk': 'walking',
        'bike': 'cycling',
        'public': 'driving' // OSRMæ²¡æœ‰ä¸“é—¨çš„å…¬å…±äº¤é€šæ¨¡å¼ï¼Œä½¿ç”¨é©¾è½¦ä½œä¸ºè¿‘ä¼¼
      };
      return profiles[transport] || 'driving';
    }

    function getTransportName(transport) {
      const names = {
        'car': 'é©¾è½¦',
        'walk': 'æ­¥è¡Œ',
        'bike': 'éª‘è¡Œ',
        'public': 'å…¬å…±äº¤é€š'
      };
      return names[transport] || 'é©¾è½¦';
    }

    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      
      if (hours > 0) {
        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
      } else {
        return `${minutes}åˆ†é’Ÿ`;
      }
    }

    // ---------- å°å·¥å…· ----------
    function genId() { return 't' + Math.random().toString(36).slice(2,9); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }



    // ---------- åŠ è½½å·²ä¿å­˜è¡Œç¨‹ç•Œé¢ï¼ˆåˆæ¬¡ï¼‰ ----------
    renderCurrentTrip();
    loadSavedTripsUI();
  </script>
</body>
</html>